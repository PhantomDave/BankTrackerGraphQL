name: Backend API - Build and Lint

on:
  push:
    branches: [main, develop]
    paths:
      - "PhantomDave.BankTracking.Api/**"
      - "PhantomDave.BankTracking.Library/**"
      - "PhantomDave.BankTracking.sln"
      - ".github/workflows/backend-api.yml"
  workflow_dispatch:
  workflow_call:

jobs:
  build-and-lint:
    name: Build and Lint Backend API
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "9.0.x"

      - name: Restore dependencies
        run: dotnet restore PhantomDave.BankTracking.Api/PhantomDave.BankTracking.Api.csproj

      - name: Format code
        if: ${{ github.event.pull_request.base.ref == 'main' }}
        run: dotnet format PhantomDave.BankTracking.Api/PhantomDave.BankTracking.Api.csproj --verbosity diagnostic

      - name: Commit formatted code
        if: ${{ github.event.pull_request.base.ref == 'main' }}
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          commit_message: "chore: auto-format Backend API code"
          file_pattern: "PhantomDave.BankTracking.Api/**"

      - name: Build
        run: dotnet build PhantomDave.BankTracking.Api/PhantomDave.BankTracking.Api.csproj --configuration Release --no-restore
