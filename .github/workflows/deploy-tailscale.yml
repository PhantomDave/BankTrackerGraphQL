name: Deploy via Tailscale

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: deploy-main
  cancel-in-progress: false

env:
  DEPLOY_DIR: /opt/banktracker/BankTrackerGraphQL

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Connect to Tailscale
        uses: tailscale/github-action@v4
        with:
          oauth-client-id: ${{ secrets.TAILSCALE_OAUTH_CLIENTID }}
          oauth-secret: ${{ secrets.TAILSCALE_OAUTH_CLIENT_SECRET }}
          hostname: banktracker-ci-${{ github.run_id }}

      - name: Configure SSH target
        id: ssh
        run: |
          TARGET="${{ secrets.TAILSCALE_SSH_TARGET }}"
          if [[ -z "$TARGET" ]]; then
            echo "::error::TAILSCALE_SSH_TARGET secret is not set"
            exit 1
          fi
          echo "target=$TARGET" >> "$GITHUB_OUTPUT"

      - name: Test connectivity
        run: |
          tailscale ssh "${{ steps.ssh.outputs.target }}" "echo 'Connected' && git config --global --add safe.directory $DEPLOY_DIR"

      - name: Pull latest code
        run: |
          tailscale ssh "${{ steps.ssh.outputs.target }}" \
            "cd $DEPLOY_DIR && git restore . && git pull origin main"

      - name: Deploy backend services
        run: |
          tailscale ssh "${{ steps.ssh.outputs.target }}" \
            "cd $DEPLOY_DIR && docker compose down && docker compose up -d --build --wait database backend"

      - name: Download GraphQL schema
        run: |
          tailscale ssh "${{ steps.ssh.outputs.target }}" \
            "cd $DEPLOY_DIR/frontend && curl -f http://localhost:5095/graphql?sdl -o schema.graphql"

      - name: Deploy frontend
        run: |
          tailscale ssh "${{ steps.ssh.outputs.target }}" \
            "cd $DEPLOY_DIR && docker compose up -d --build --wait frontend"

      - name: Verify deployment
        if: success()
        run: |
          tailscale ssh "${{ steps.ssh.outputs.target }}" "cd $DEPLOY_DIR && docker compose ps"
