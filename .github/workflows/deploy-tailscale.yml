name: Deploy via Tailscale

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: deploy-main
  cancel-in-progress: false

env:
  DEPLOY_DIR: /opt/banktracker/BankTrackerGraphQL

jobs:
  wait-for-images:
    name: Wait for Container Images
    runs-on: ubuntu-latest
    permissions:
      actions: read
    steps:
      - name: Wait for backend image build
        uses: lewagon/wait-on-check-action@v1.3.4
        with:
          ref: ${{ github.ref }}
          check-name: 'Build and Push Backend Container'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 10

      - name: Wait for frontend image build
        uses: lewagon/wait-on-check-action@v1.3.4
        with:
          ref: ${{ github.ref }}
          check-name: 'Build and Push Frontend Container'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 10

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: wait-for-images
    permissions:
      contents: read
      packages: read
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Connect to Tailscale
        uses: tailscale/github-action@v4
        with:
          oauth-client-id: ${{ secrets.TAILSCALE_OAUTH_CLIENTID }}
          oauth-secret: ${{ secrets.TAILSCALE_OAUTH_CLIENT_SECRET }}
          tags: tag:ci
          hostname: banktracker-ci-${{ github.run_id }}

      - name: Configure SSH target
        id: ssh
        run: |
          TARGET="${{ secrets.TAILSCALE_SSH_TARGET }}"
          if [[ -z "$TARGET" ]]; then
            echo "::error::TAILSCALE_SSH_TARGET secret is not set"
            exit 1
          fi
          echo "target=$TARGET" >> "$GITHUB_OUTPUT"

      - name: Test connectivity
        run: |
          tailscale ssh "${{ steps.ssh.outputs.target }}" "echo 'Connected'"

      - name: Log in to GitHub Container Registry
        run: |
          tailscale ssh "${{ steps.ssh.outputs.target }}" \
            "echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin"

      - name: Pull latest images
        run: |
          tailscale ssh "${{ steps.ssh.outputs.target }}" \
            "cd $DEPLOY_DIR && docker compose pull"

      - name: Deploy all services
        run: |
          tailscale ssh "${{ steps.ssh.outputs.target }}" \
            "cd $DEPLOY_DIR && docker compose down && docker compose up -d --wait"

      - name: Verify deployment
        if: success()
        run: |
          tailscale ssh "${{ steps.ssh.outputs.target }}" "cd $DEPLOY_DIR && docker compose ps"
