name: Frontend - Build and Lint

on:
  push:
    branches: [main, develop]
    paths:
      - "frontend/**"
      - ".github/workflows/frontend.yml"
  workflow_run:
    workflows: ["Build and Push Backend Image", "Build and Push Frontend Image"]
    types: [completed]
  workflow_dispatch:
  workflow_call:

jobs:
  build-and-lint:
    name: Build and Lint Frontend
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        working-directory: ./frontend
        run: bun install --frozen-lockfile

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "9.0.x"

      - name: Restore dependencies
        run: dotnet restore PhantomDave.BankTracking.Api/PhantomDave.BankTracking.Api.csproj

      - name: Spin up Database with Docker Compose
        run: docker compose up database -d --wait

      - name: Start API in background
        working-directory: ./PhantomDave.BankTracking.Api
        run: |
          dotnet run > api.log 2>&1 &
          echo $! > api.pid
        env:
          ASPNETCORE_ENVIRONMENT: Development

      - name: Wait for API to be ready
        uses: jtalk/url-health-check-action@v4
        with:
          url: http://localhost:5095/graphql
          max-attempts: 15
          retry-delay: 2s

      - name: Show API logs on failure
        if: failure()
        working-directory: ./PhantomDave.BankTracking.Api
        run: |
          echo "=== API Logs ==="
          cat api.log || echo "No log file found"

      - name: Generate GraphQL types
        working-directory: ./frontend
        run: bun run codegen

      - name: Format code with Prettier
        working-directory: ./frontend
        run: bun run prettier --write "src/**/*.{ts,html,css,scss}"
      - name: Commit formatted code
        uses: stefanzweifel/git-auto-commit-action@v7
        if: github.event_name == 'push'
        with:
          commit_message: "chore: auto-format Frontend code"
          file_pattern: "frontend/src/**"

      - name: Check TypeScript compilation
        working-directory: ./frontend
        run: bun run tsc --noEmit

      - name: Build
        working-directory: ./frontend
        run: bun run build -- --configuration=development
