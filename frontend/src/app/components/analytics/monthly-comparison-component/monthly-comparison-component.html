<mat-card appearance="outlined" class="comparison-card">
  <mat-card-header>
    <mat-icon mat-card-avatar>analytics</mat-icon>
    <mat-card-title>Month-over-Month Comparison</mat-card-title>
    <mat-card-subtitle>Analyze spending patterns across months</mat-card-subtitle>
  </mat-card-header>

  <mat-card-content>
    <!-- Date Range Filter -->
    <form [formGroup]="dateRangeForm" class="date-filter">
      <app-flex>
        <mat-form-field appearance="outline">
          <mat-label>Start Date</mat-label>
          <input matInput [matDatepicker]="startPicker" formControlName="startDate" />
          <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
          <mat-datepicker #startPicker></mat-datepicker>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>End Date</mat-label>
          <input matInput [matDatepicker]="endPicker" formControlName="endDate" />
          <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
          <mat-datepicker #endPicker></mat-datepicker>
        </mat-form-field>

        <button mat-raised-button color="primary" (click)="loadComparison()" [disabled]="loading()">
          <mat-icon>refresh</mat-icon>
          Update
        </button>
      </app-flex>
    </form>

    <!-- Loading State -->
    @if (loading()) {
      <div class="loading-container">
        <mat-progress-spinner mode="indeterminate" diameter="48"></mat-progress-spinner>
        <p>Loading comparison data...</p>
      </div>
    }

    <!-- Error State -->
    @if (error()) {
      <div class="error-message">
        <mat-icon color="warn">error</mat-icon>
        <p>{{ error() }}</p>
      </div>
    }

    <!-- Summary Statistics -->
    @if (summaryStats(); as stats) {
      <div class="summary-grid">
        <mat-card appearance="outlined" class="stat-card">
          <mat-icon>calendar_today</mat-icon>
          <div class="stat-value">{{ stats.totalMonths }}</div>
          <div class="stat-label">Months Analyzed</div>
        </mat-card>

        <mat-card appearance="outlined" class="stat-card">
          <mat-icon color="primary">trending_up</mat-icon>
          <div class="stat-value">{{ stats.avgIncome | currency: 'EUR' }}</div>
          <div class="stat-label">Avg Monthly Income</div>
        </mat-card>

        <mat-card appearance="outlined" class="stat-card">
          <mat-icon color="warn">trending_down</mat-icon>
          <div class="stat-value">{{ stats.avgExpense | currency: 'EUR' }}</div>
          <div class="stat-label">Avg Monthly Expense</div>
        </mat-card>

        <mat-card appearance="outlined" class="stat-card">
          <mat-icon>insights</mat-icon>
          <div class="stat-value">{{ stats.highestMonth }}</div>
          <div class="stat-label">Highest Spending</div>
        </mat-card>
      </div>
    }

    <!-- Monthly Data Table -->
    @if (monthlyDataRows().length > 0) {
      <table mat-table [dataSource]="monthlyDataRows()" class="comparison-table">
        <!-- Month Column -->
        <ng-container matColumnDef="month">
          <th mat-header-cell *matHeaderCellDef>Month</th>
          <td mat-cell *matCellDef="let row">{{ row.monthLabel }}</td>
        </ng-container>

        <!-- Income Column -->
        <ng-container matColumnDef="income">
          <th mat-header-cell *matHeaderCellDef>Income</th>
          <td mat-cell *matCellDef="let row" class="positive">
            {{ row.totalIncome | currency: 'EUR' }}
          </td>
        </ng-container>

        <!-- Expense Column -->
        <ng-container matColumnDef="expense">
          <th mat-header-cell *matHeaderCellDef>Expenses</th>
          <td mat-cell *matCellDef="let row" class="negative">
            {{ row.totalExpense | currency: 'EUR' }}
          </td>
        </ng-container>

        <!-- Net Column -->
        <ng-container matColumnDef="net">
          <th mat-header-cell *matHeaderCellDef>Net</th>
          <td
            mat-cell
            *matCellDef="let row"
            [class.positive]="row.netAmount >= 0"
            [class.negative]="row.netAmount < 0"
          >
            {{ row.netAmount | currency: 'EUR' }}
          </td>
        </ng-container>

        <!-- Transactions Column -->
        <ng-container matColumnDef="transactions">
          <th mat-header-cell *matHeaderCellDef>Transactions</th>
          <td mat-cell *matCellDef="let row">{{ row.transactionCount }}</td>
        </ng-container>

        <!-- Average Column -->
        <ng-container matColumnDef="average">
          <th mat-header-cell *matHeaderCellDef>Avg Transaction</th>
          <td mat-cell *matCellDef="let row">
            {{ row.averageTransactionAmount | currency: 'EUR' }}
          </td>
        </ng-container>

        <!-- Recurring Column -->
        <ng-container matColumnDef="recurring">
          <th mat-header-cell *matHeaderCellDef>Recurring Total</th>
          <td mat-cell *matCellDef="let row">
            {{ row.recurringIncomeTotal + row.recurringExpenseTotal | currency: 'EUR' }}
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
      </table>
    }

    <!-- Empty State -->
    @if (!loading() && !error() && monthlyDataRows().length === 0) {
      <div class="empty-state">
        <mat-icon>insights</mat-icon>
        <p>No data available for the selected date range</p>
        <button mat-raised-button color="primary" (click)="loadComparison()">Try Again</button>
      </div>
    }
  </mat-card-content>
</mat-card>
