@if (preview(); as previewData) {
  <mat-card appearance="outlined" class="detection-card">
    <mat-card-header>
      <mat-icon mat-card-avatar>analytics</mat-icon>
      <mat-card-title>Column Detection Results</mat-card-title>
      <mat-card-subtitle
        >Automatic mapping of CSV columns to finance record fields</mat-card-subtitle
      >
    </mat-card-header>

    <mat-card-content>
      <div class="detection-summary">
        <div class="summary-stat">
          <mat-icon>table_chart</mat-icon>
          <div class="stat-content">
            <span class="stat-label">Total Columns</span>
            <span class="stat-value">{{ previewData.headers.length }}</span>
          </div>
        </div>
        <div class="summary-stat">
          <mat-icon>swap_horiz</mat-icon>
          <div class="stat-content">
            <span class="stat-label">Mapped Columns</span>
            <span class="stat-value">{{ detectedColumnsArray().length }}</span>
          </div>
        </div>
        <div class="summary-stat">
          <mat-icon>description</mat-icon>
          <div class="stat-content">
            <span class="stat-label">Total Rows</span>
            <span class="stat-value">{{ previewData.totalRows }}</span>
          </div>
        </div>
      </div>

      <mat-divider></mat-divider>

      <div class="mappings-container">
        <h3 class="section-title">Detected Mappings</h3>
        <p class="section-description">
          Review and adjust column mappings as needed. Required fields: Date, Amount
        </p>
        @if (detectedColumnsArray().length === 0) {
          <div class="empty-state">
            <mat-icon>info</mat-icon>
            <p>No column mappings detected automatically. You can configure them manually below.</p>
          </div>
        } @else {
          <div class="mappings-list">
            @for (item of detectedColumnsArray(); track item.column) {
              <div
                class="mapping-item"
                [class.confidence-level]="getConfidenceColor(item.confidence)"
              >
                <div class="mapping-header">
                  <div class="column-info">
                    <mat-icon class="column-icon">view_column</mat-icon>
                    <span class="column-name">{{ item.column }}</span>
                  </div>
                  <mat-icon class="arrow-icon">arrow_forward</mat-icon>
                  <mat-form-field class="mapping-select" appearance="outline">
                    <mat-label>Map to field</mat-label>
                    <mat-select
                      [value]="getColumnMapping(item.column)"
                      (selectionChange)="updateColumnMapping(item.column, $event.value)"
                    >
                      @for (field of availableFields; track field) {
                        <mat-option [value]="field">{{ field }}</mat-option>
                      }
                    </mat-select>
                  </mat-form-field>
                </div>
                <div class="mapping-confidence">
                  <mat-icon
                    [class]="'confidence-icon ' + getConfidenceColor(item.confidence)"
                    [attr.aria-label]="getConfidenceLabel(item.confidence)"
                  >
                    {{ getConfidenceIcon(item.confidence) }}
                  </mat-icon>
                  <span class="confidence-label">{{ getConfidenceLabel(item.confidence) }}</span>
                  <span class="confidence-percentage">{{ item.confidence.toFixed(0) }}%</span>
                  <div class="confidence-bar">
                    <div
                      class="confidence-fill"
                      [class]="getConfidenceColor(item.confidence)"
                      [style.width.%]="item.confidence"
                    ></div>
                  </div>
                </div>
              </div>
            }
          </div>
        }
        @if (getDuplicateMapping().length > 0) {
          <div class="mapping-warning">
            <mat-icon>warning</mat-icon>
            <span
              >Warning: Multiple columns are mapped to the same field:
              {{ getDuplicateMapping().join(', ') }}. Please ensure each field is mapped
              uniquely.</span
            >
          </div>
        }
      </div>

      @if (previewData.sampleRows.length > 0) {
        <mat-divider></mat-divider>
        <div class="sample-preview">
          <h3 class="section-title">Sample Data Preview</h3>
          <div class="sample-table-container">
            <table class="sample-table">
              <thead>
                <tr>
                  @for (header of previewData.headers; track header) {
                    <th>{{ header }}</th>
                  }
                </tr>
              </thead>
              <tbody>
                @for (row of previewData.sampleRows.slice(0, 5); track $index) {
                  <tr>
                    @for (header of previewData.headers; track header) {
                      <td>{{ row[header] }}</td>
                    }
                  </tr>
                }
              </tbody>
            </table>
          </div>
        </div>
      }
    </mat-card-content>
  </mat-card>
} @else {
  <div class="no-preview">
    <mat-icon>cloud_upload</mat-icon>
    <p>No file uploaded yet. Please upload a file in the previous step.</p>
  </div>
}
